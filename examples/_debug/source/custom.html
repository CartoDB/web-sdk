<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Custom Maps API</title>

    <link
            rel="stylesheet"
            type="text/css"
            href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css"
    />
    <link
            rel="stylesheet"
            type="text/css"
            href="https://libs.cartocdn.com/airship-style/v2.3/airship.css"
    />

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>

<body class="as-app-body as-app">
<div class="as-content">
    <main class="as-main">
        <div class="as-map-area">
            <!-- map -->
            <div id="map"></div>

            <!-- panel -->
            <div class="as-panel as-panel--top as-panel--right as-bg--ui-01">
                <div class="as-panel__element as-p--16 as-body">
                    <h1 class="as-title">Use custom Maps API instantiation</h1>
                    <h4 class="as-subheader as-mb--12">
                        A (short) description of the example
                    </h4>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/deck.gl@8.2.0-alpha.2/dist.min.js"></script>
<script src="/dist/umd/index.min.js"></script>

<script>
  async function getMapInstantiation(sql, options) {
    const config = {
      version: '1.3.1',
      buffersize: { mvt: 10 },
      layers: [{
        type: 'mapnik',
        options: {
          sql,
          vector_extent: 2048,
          vector_simplify_extent: 2048,
          aggregation: {},
          metadata: { geometryType: true }
        }
      }]
    };

    try {
      const response = await this.makeMapsApiRequest(config);
      return response;
    } catch (error) {
      throw new Error(`[layerService.js] Failed to connect to Maps API with your user: ${error}`);
    }
  }

  function makeMapsApiRequest(config) {
    const host = 'https://{user}.carto.com';
    const user = 'public';
    const apikey = 'default_public';
    const url = `${host.replace('{user}', user)}/api/v1/map?api_key=${apikey}`;
    const getUrl = `${url}&client=vl-1.4.4&config=${JSON.stringify(config)}`;
    if (getUrl.length > 1024) {
      return fetch(url, { method: 'POST', body: JSON.stringify(config) }).then(res => res.json());
    } else {
      return fetch(getUrl).then(res => res.json());
    }
  }
</script>

<script>
  async function initialize() {
    carto.setDefaultCredentials({ username: 'public' });
    const deckMap = carto.viz.createMap();
    const layerInstantiation = await getMapInstantiation('SELECT * FROM world_ports');
    debugger
    const countriesLayer = new carto.viz.Layer(layerInstantiation);
    countriesLayer.addTo(deckMap);
  }

  initialize();
</script>
</body>
</html>